# Cloud Build configuration for HSS Backend (FIXED: no invalid built-in substitutions)
# Triggers: develop branch (dev), v* tags (prod)
# Optimizations: safer fallbacks, caching, backoff, improved logging

steps:
  # 1) Setup: Java + Maven deps
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'setup'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euo pipefail
        echo "âš™ï¸ Setup baÅŸlÄ±yor..."
        echo "Mevcut dizin: $(pwd)"

        # _PROJECT_DIR varsa kullan, yoksa otomatik bul
        if [ -n "${_PROJECT_DIR:-}" ] && [ -d "${_PROJECT_DIR}" ]; then
          EFFECTIVE_PROJECT_DIR="${_PROJECT_DIR}"
          cd "${_PROJECT_DIR}"
          echo "âœ… _PROJECT_DIR kullanÄ±ldÄ±: ${_PROJECT_DIR}"
        elif [ -d "hss-backend" ]; then
          EFFECTIVE_PROJECT_DIR="hss-backend"
          cd hss-backend
          echo "âœ… hss-backend dizinine geÃ§ildi"
        elif [ -f "pom.xml" ]; then
          EFFECTIVE_PROJECT_DIR="."
          echo "âœ… Mevcut dizinde pom.xml bulundu"
        else
          echo "âŒ FATAL: Proje dizini bulunamadÄ± (hss-backend veya pom.xml yok)!"
          ls -la
          exit 1
        fi

        # Proje dizinini diÄŸer adÄ±mlar iÃ§in kaydet
        echo "$${EFFECTIVE_PROJECT_DIR}" > /workspace/project_dir.txt
        echo "ðŸ“ Proje dizini kaydedildi: $${EFFECTIVE_PROJECT_DIR}"

        # Java 21 kurulumu
        echo "â˜• Java 21 kuruluyor..."
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -qq && apt-get install -y -qq openjdk-21-jdk-headless > /dev/null 2>&1

        echo "ðŸ“¦ Java workspace'e taÅŸÄ±nÄ±yor..."
        rsync -a /usr/lib/jvm/java-21-openjdk-amd64/ /workspace/java/

        if [ ! -d "/workspace/java/bin" ]; then
          echo "âŒ FATAL: Java kurulumu baÅŸarÄ±sÄ±z!"
          exit 1
        fi

        export JAVA_HOME=/workspace/java
        export PATH=$JAVA_HOME/bin:$PATH
        java -version

        # Maven cache
        mkdir -p /workspace/.m2/repository
        export MAVEN_OPTS="-Xmx512m -XX:+UseG1GC -XX:+UseStringDeduplication"

        echo "ðŸ“¥ Maven dependencies indiriliyor..."
        ./mvnw -B dependency:go-offline \
          -Dmaven.repo.local=/workspace/.m2/repository \
          -Dmaven.test.skip=true \
          -Dmaven.javadoc.skip=true \
          -Dmaven.source.skip=true \
          -q 2>&1 | tee /workspace/setup.log || {
          echo "âŒ Dependency download baÅŸarÄ±sÄ±z!"
          tail -n 200 /workspace/setup.log || true
          exit 1
        }

        echo "SUCCESS" > /workspace/setup_status.txt
        echo "âœ… Setup tamamlandÄ±!"
    waitFor: []

  # 2) Test
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'test'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euo pipefail
        echo "ðŸ§ª Testler Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."

        [ -f /workspace/setup_status.txt ] && [ "$(cat /workspace/setup_status.txt)" = "SUCCESS" ] || {
          echo "âŒ FATAL: Setup baÅŸarÄ±sÄ±z!"
          exit 1
        }

        # Kaydedilen proje dizinine geÃ§ (gerekirse)
        if [ -f /workspace/project_dir.txt ]; then
          PDIR="$(cat /workspace/project_dir.txt)"
          [ "$PDIR" != "." ] && cd "$PDIR" || true
        elif [ -d "hss-backend" ]; then
          cd hss-backend
        fi

        export JAVA_HOME=/workspace/java
        export PATH=$JAVA_HOME/bin:$PATH
        export MAVEN_OPTS="-Xmx512m -XX:+UseG1GC -XX:+UseStringDeduplication"

        [ -x "$JAVA_HOME/bin/java" ] || { echo "âŒ FATAL: Java yok!"; exit 1; }
        echo "â˜• Java: $(java -version 2>&1 | head -n1)"

        if [ "${_ENVIRONMENT}" = "prod" ]; then
          echo "ðŸ” Production testleri..."
          ./mvnw -B test -Dmaven.repo.local=/workspace/.m2/repository \
            2>&1 | tee /workspace/test.log
        else
          echo "âš¡ Development testleri (unit aÄŸÄ±rlÄ±klÄ±)..."
          ./mvnw -B test -Dtest='!*IntegrationTest,!*E2ETest' \
            -Dmaven.repo.local=/workspace/.m2/repository \
            2>&1 | tee /workspace/test.log || {
            echo "âš ï¸ Dev ortamÄ±nda bazÄ± testler fail olabilir (non-blocking)"
          }
        fi

        echo "âœ… Testler tamam!"
    waitFor: ['setup']

  # 3) Build (parallel)
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'build'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euo pipefail
        echo "ðŸ”¨ Build baÅŸlÄ±yor..."

        [ -f /workspace/setup_status.txt ] && [ "$(cat /workspace/setup_status.txt)" = "SUCCESS" ] || {
          echo "âŒ FATAL: Setup baÅŸarÄ±sÄ±z!"
          exit 1
        }

        if [ -f /workspace/project_dir.txt ]; then
          PDIR="$(cat /workspace/project_dir.txt)"
          [ "$PDIR" != "." ] && cd "$PDIR" || true
        elif [ -d "hss-backend" ]; then
          cd hss-backend
        fi

        export JAVA_HOME=/workspace/java
        export PATH=$JAVA_HOME/bin:$PATH
        export MAVEN_OPTS="-Xmx512m -XX:+UseG1GC -XX:+UseStringDeduplication"
        [ -x "$JAVA_HOME/bin/java" ] || { echo "âŒ FATAL: Java yok!"; exit 1; }

        echo "â˜• Java: $(java -version 2>&1 | head -n1)"
        echo "ðŸ”¨ Maven package (revision=${SHORT_SHA})"
        ./mvnw -B clean package -DskipTests -Drevision=${SHORT_SHA} \
          -Dmaven.repo.local=/workspace/.m2/repository \
          2>&1 | tee /workspace/build.log || {
          echo "âŒ Build baÅŸarÄ±sÄ±z! Son 50 satÄ±r:"
          tail -n 50 /workspace/build.log
          exit 1
        }

        ls -lh target/*.jar || { echo "âŒ FATAL: JAR bulunamadÄ±!"; exit 1; }
        echo "âœ… Build baÅŸarÄ±lÄ±!"
    waitFor: ['setup']

  # 4) Docker build
  - name: 'gcr.io/cloud-builders/docker'
    id: 'docker-build'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euo pipefail
        MY_IMG_PATH="${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/hss-backend"

        echo "ðŸ³ Docker build..."
        echo "Env: ${_ENVIRONMENT}, Tag: ${_TAG_NAME}"

        if [ -f /workspace/project_dir.txt ]; then
          PDIR="$(cat /workspace/project_dir.txt)"
          [ "$PDIR" != "." ] && cd "$PDIR" || true
        elif [ -d "hss-backend" ]; then
          cd hss-backend
        fi
        echo "ðŸ“‚ Ã‡alÄ±ÅŸma dizini: $(pwd)"

        [ -f Dockerfile ] || { echo "âŒ FATAL: Dockerfile yok!"; ls -la; exit 1; }
        ls -1 target/*.jar >/dev/null 2>&1 || { echo "âŒ FATAL: JAR yok!"; exit 1; }

        echo "ðŸ“¦ Cache pull denemeleri..."
        docker pull "$${MY_IMG_PATH}:latest" 2>/dev/null || echo "â„¹ï¸ latest cache yok"
        docker pull "$${MY_IMG_PATH}:${_TAG_NAME}" 2>/dev/null || echo "â„¹ï¸ tag cache yok"

        echo "ðŸ”¨ docker build"
        docker build \
          --tag "$${MY_IMG_PATH}:${SHORT_SHA}" \
          --tag "$${MY_IMG_PATH}:${_TAG_NAME}" \
          --tag "$${MY_IMG_PATH}:latest" \
          --cache-from "$${MY_IMG_PATH}:latest" \
          --cache-from "$${MY_IMG_PATH}:${_TAG_NAME}" \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
          --build-arg VCS_REF=${SHORT_SHA} \
          --build-arg VERSION=${_TAG_NAME} \
          --build-arg ENVIRONMENT=${_ENVIRONMENT} \
          --progress=plain \
          --memory=2g \
          --memory-swap=2g \
          . 2>&1 | tee /workspace/docker_build.log || {
          echo "âŒ Docker build hata! Son 100 satÄ±r:"
          tail -n 100 /workspace/docker_build.log
          exit 1
        }

        docker images "$${MY_IMG_PATH}:${SHORT_SHA}" || true
        echo "âœ… Docker build baÅŸarÄ±lÄ±!"
    waitFor: ['test', 'build']

  # 5) Docker push
  - name: 'gcr.io/cloud-builders/docker'
    id: 'docker-push'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euo pipefail
        MY_IMG_PATH="${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/hss-backend"

        echo "ðŸ“¤ Docker push..."
        for TAG in "${SHORT_SHA}" "${_TAG_NAME}" "latest"; do
          echo "â¬†ï¸ Pushing $${MY_IMG_PATH}:$${TAG}..."
          for ATTEMPT in 1 2 3; do
            if docker push "$${MY_IMG_PATH}:$${TAG}"; then
              echo "âœ… $${TAG} push ok"
              break
            elif [ "$ATTEMPT" -lt 3 ]; then
              echo "âš ï¸ Push retry $ATTEMPT/3"
              sleep 5
            else
              echo "âŒ Push failed: $${TAG}"
              exit 1
            fi
          done
        done
        echo "âœ… TÃ¼m tag'ler push edildi!"
    waitFor: ['docker-build']

  # 6) Migration (only prod)
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'migrate'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euo pipefail
        if [ "${_ENVIRONMENT}" != "prod" ]; then
          echo "â„¹ï¸ Dev ortamÄ± - migration atlandÄ±"
          exit 0
        fi

        echo "ðŸ—„ï¸ Prod migration..."
        [ -f /workspace/setup_status.txt ] && [ "$(cat /workspace/setup_status.txt)" = "SUCCESS" ] || {
          echo "âŒ FATAL: Setup yok!"
          exit 1
        }

        if [ -f /workspace/project_dir.txt ]; then
          PDIR="$(cat /workspace/project_dir.txt)"
          [ "$PDIR" != "." ] && cd "$PDIR" || true
        elif [ -d "hss-backend" ]; then
          cd hss-backend
        fi

        export JAVA_HOME=/workspace/java
        export PATH=$JAVA_HOME/bin:$PATH
        export MAVEN_OPTS="-Xmx512m -XX:+UseG1GC -XX:+UseStringDeduplication"

        [ -x "$JAVA_HOME/bin/java" ] || { echo "âŒ FATAL: Java yok!"; exit 1; }
        echo "â˜• Java: $(java -version 2>&1 | head -n1)"

        echo "ðŸ”„ Flyway migrate..."
        ./mvnw -B flyway:migrate \
          -Dflyway.url="jdbc:postgresql:///hss_prod?socketFactory=com.google.cloud.sql.postgres.SocketFactory&cloudSqlInstance=${_CONNECTION_NAME}" \
          -Dflyway.user="${_DB_USERNAME_PROD_SECRET}" \
          -Dflyway.password="${_DB_PASSWORD_PROD_SECRET}" \
          -Dflyway.locations=classpath:db/migration \
          -Dflyway.baselineOnMigrate=true \
          -Dflyway.validateOnMigrate=false \
          -Dflyway.outOfOrder=false \
          -Dmaven.repo.local=/workspace/.m2/repository \
          2>&1 | tee /workspace/migration.log || {
          echo "âŒ Migration hata! Log:"
          tail -n 200 /workspace/migration.log || true
          exit 1
        }

        echo "âœ… Migration tamam!"
    waitFor: ['docker-push']

  # 7) Deploy Cloud Run
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'deploy'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euo pipefail
        echo "ðŸš€ Cloud Run deploy..."
        echo "Environment: ${_ENVIRONMENT}"

        if [ "${_ENVIRONMENT}" = "prod" ]; then
          MY_SPRING_PROFILE="prod"
          MY_SERVICE_NAME="hss-backend"
          MY_MIN_INSTANCES="1"
          MY_MAX_INSTANCES="10"
          MY_MEMORY="1Gi"
          MY_CPU="2"
          MY_TIMEOUT="600"
          MY_CONCURRENCY="100"
          MY_DB="hss_prod"
          MY_DB_USERNAME_SECRET="${_DB_USERNAME_PROD_SECRET}"
          MY_DB_PASSWORD_SECRET="${_DB_PASSWORD_PROD_SECRET}"
        else
          MY_SPRING_PROFILE="dev"
          MY_SERVICE_NAME="hss-backend-dev"
          MY_MIN_INSTANCES="0"
          MY_MAX_INSTANCES="3"
          MY_MEMORY="512Mi"
          MY_CPU="1"
          MY_TIMEOUT="300"
          MY_CONCURRENCY="80"
          MY_DB="hss_dev"
          MY_DB_USERNAME_SECRET="${_DB_USERNAME_SECRET}"
          MY_DB_PASSWORD_SECRET="${_DB_PASSWORD_SECRET}"
        fi

        gcloud run deploy "$${MY_SERVICE_NAME}" \
          --image="${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/hss-backend:${SHORT_SHA}" \
          --region="${_REGION}" \
          --service-account="${_SERVICE_ACCOUNT}" \
          --platform=managed \
          --allow-unauthenticated \
          --set-env-vars="SPRING_PROFILES_ACTIVE=$${MY_SPRING_PROFILE},DB_NAME=$${MY_DB}" \
          --set-env-vars="GCP_SQL_INSTANCE_CONNECTION_NAME=${_CONNECTION_NAME}" \
          --set-secrets="DB_USERNAME=$${MY_DB_USERNAME_SECRET}:latest,DB_PASSWORD=$${MY_DB_PASSWORD_SECRET}:latest" \
          --add-cloudsql-instances="${_CONNECTION_NAME}" \
          --min-instances="$${MY_MIN_INSTANCES}" \
          --max-instances="$${MY_MAX_INSTANCES}" \
          --memory="$${MY_MEMORY}" \
          --cpu="$${MY_CPU}" \
          --timeout="$${MY_TIMEOUT}" \
          --concurrency="$${MY_CONCURRENCY}" \
          --port=8080 \
          --no-traffic \
          --quiet

        MY_URL=$(gcloud run services describe "$${MY_SERVICE_NAME}" --region=${_REGION} --format='value(status.url)')
        echo "âœ… Deploy baÅŸarÄ±lÄ±: $${MY_SERVICE_NAME}"
        echo "ðŸŒ URL: $${MY_URL}"

        echo "ðŸ” Health check (exponential backoff)..."
        MAX_ATTEMPTS=6
        for i in $(seq 1 $$MAX_ATTEMPTS); do
          echo "â³ Deneme $$i/$$MAX_ATTEMPTS..."
          if curl -sf --max-time 10 --retry 2 --retry-delay 2 "$${MY_URL}/actuator/health" >/dev/null 2>&1; then
            echo "âœ… Servis saÄŸlÄ±klÄ±!"
            exit 0
          fi
          if [ $$i -lt $$MAX_ATTEMPTS ]; then
            WAIT_TIME=$$((2 ** $$i))
            echo "â³ Bekleniyor: $${WAIT_TIME}s"
            sleep $$WAIT_TIME
          fi
        done

        echo "âš ï¸ Health check timeout (deploy baÅŸarÄ±lÄ±)"
        echo "â„¹ï¸ Manuel kontrol: $${MY_URL}/actuator/health"
    waitFor: ['migrate']

  # 8) Release artifacts (prod only)
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'release'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euo pipefail
        if [ "${_ENVIRONMENT}" != "prod" ]; then
          echo "â„¹ï¸ Dev ortamÄ± - release atlandÄ±"
          exit 0
        fi

        echo "ðŸ“¦ Release artifacts hazÄ±rlanÄ±yor..."
        MY_IMG_PATH="${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/hss-backend:${SHORT_SHA}"
        MY_VERSION="${_TAG_NAME}"
        MY_BUCKET="gs://hss-releases-${PROJECT_ID}"

        cat > /workspace/manifest.json << EOF
        {
          "version": "$${MY_VERSION}",
          "environment": "production",
          "image": "$${MY_IMG_PATH}",
          "commit_sha": "${SHORT_SHA}",
          "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "deployed_by": "${BUILD_ID}"
        }
        EOF

        echo "â¬†ï¸ YÃ¼kleniyor..."
        for ATTEMPT in 1 2 3; do
          if gsutil -m cp /workspace/manifest.json "$${MY_BUCKET}/releases/$${MY_VERSION}/manifest.json" && \
             gsutil -m cp /workspace/manifest.json "$${MY_BUCKET}/releases/latest/manifest.json"; then
            echo "âœ… Release artifacts yÃ¼klendi!"
            exit 0
          elif [ "$ATTEMPT" -lt 3 ]; then
            echo "âš ï¸ Retry $ATTEMPT/3"
            sleep 3
          else
            echo "âš ï¸ UyarÄ±: Release yÃ¼klenemedi (non-critical)"
            exit 0
          fi
        done
    waitFor: ['deploy']

  # 9) Monitoring
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'monitoring'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euo pipefail
        echo "ðŸ“Š Monitoring log gÃ¶nderiliyor..."
        gcloud logging write hss-deployment \
          "Backend deployment completed successfully" \
          --severity=INFO \
          --payload-type=json \
          --payload="{
            \"service\": \"hss-backend\",
            \"environment\": \"${_ENVIRONMENT}\",
            \"version\": \"${_TAG_NAME}\",
            \"commit_sha\": \"${SHORT_SHA}\",
            \"build_id\": \"${BUILD_ID}\",
            \"deployment_time\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
          }" || {
          echo "âš ï¸ Monitoring gÃ¶nderilemedi (non-critical)"
        }
        echo "âœ… Monitoring tamam!"
    waitFor: ['deploy']

# Substitutions (FIXED: only custom keys prefixed with _)
substitutions:
  _REGION: 'europe-west3'
  _REPO_NAME: 'hss-backend'
  _SERVICE_ACCOUNT: 'hss-backend-sa@hss-cloud-473511.iam.gserviceaccount.com'
  _CONNECTION_NAME: 'hss-cloud-473511:europe-west3:hss-sql'
  _DB_USERNAME_SECRET: 'DB_USERNAME'
  _DB_PASSWORD_SECRET: 'DB_PASSWORD'
  _DB_USERNAME_PROD_SECRET: 'DB_USERNAME_PROD'
  _DB_PASSWORD_PROD_SECRET: 'DB_PASSWORD_PROD'
  _ENVIRONMENT: 'dev'
  _TAG_NAME: 'dev'
  # Ä°stersen sabitle: _PROJECT_DIR: 'hss-backend'

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'
  diskSizeGb: 50
  substitution_option: 'ALLOW_LOOSE'
  dynamic_substitutions: false
  env:
    - 'DOCKER_BUILDKIT=1'
    - 'MAVEN_OPTS=-Xmx512m -XX:+UseG1GC -XX:+UseStringDeduplication'

timeout: '1200s'

images:
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/hss-backend:${SHORT_SHA}'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/hss-backend:${_TAG_NAME}'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/hss-backend:latest'
